<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book an Appointment - Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/user_responsive.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar-link.active {
            background-color: #FEF2F2; /* red-50 */
            color: #A52A2A; /* maroon */
            font-weight: 600;
            border-right: 4px solid #A52A2A;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-6">
            <a href="{{ url_for('home') }}" class="text-red-600 bg-white border-2 border-red-600 rounded-full w-12 h-12 flex items-center justify-center shadow-md hover:bg-red-50 transition">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center">Book an Appointment</h1>
            <div class="w-12"></div> <!-- Spacer -->
        </header>

        <!-- Main Content -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Sidebar -->
            <aside class="w-full lg:w-1/4">
                <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                    <!-- Step 1: Type (faded on subsequent steps) -->
                    <div class="flex items-center p-3 text-gray-500 rounded-lg cursor-default">
                        <i class="fas fa-list-alt fa-fw mr-3"></i> Type
                    </div>
                    <!-- Completed Steps - Not clickable -->
                    <div class="flex items-center p-3 text-gray-500 rounded-lg cursor-default">
                        <i class="fas fa-pills fa-fw mr-3"></i> Services & Fees
                    </div>
                    <div class="flex items-center p-3 mt-2 text-gray-500 rounded-lg cursor-default">
                        <i class="fas fa-calendar fa-fw mr-3"></i> Date & Time
                    </div>
                    <!-- Current Step - Not clickable -->
                    <div class="sidebar-link active flex items-center p-3 mt-2 text-gray-600 rounded-lg cursor-default">
                        <i class="fas fa-user-edit fa-fw mr-3"></i> Details
                    </div>
                    <!-- Upcoming Steps - Not clickable and faded -->
                    <div class="flex items-center p-3 mt-2 text-gray-400 rounded-lg cursor-default">
                        <i class="fas fa-file-alt fa-fw mr-3"></i> Summary
                    </div>
                </div>
            </aside>

            <!-- Right Content -->
            <main class="w-full lg:w-3/4">
                <form id="details-form" action="{{ url_for('appointment_details') }}" method="POST" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-200">
                    {%- set details = appointment_details if appointment_details is defined else session.appointment_details -%}
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Details</h2>
                    
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" value="{{ details.name if details and details.name else '' }}" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                    </div>

                    <div class="mb-4">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address <span class="text-red-500">*</span></label>
                        <input type="text" id="address" name="address" value="{{ details.address if details and details.address else '' }}" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="date_of_birth" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth <span class="text-red-500">*</span></label>
                            <div class="flex items-center gap-3">
                                <input type="date" id="date_of_birth" name="date_of_birth" value="{{ details.date_of_birth if details and details.date_of_birth else '' }}" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                                <div id="age_display" class="text-sm text-gray-600">Age: <span id="age_years" class="font-semibold">--</span></div>
                            </div>
                            <!-- Hidden age field kept for backward compatibility and server workflows -->
                            <input type="hidden" id="age" name="age" value="{{ details.age if details and details.age else '' }}">
                        </div>
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender <span class="text-red-500">*</span></label>
                            <select id="gender" name="gender" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                                <option value="">Select gender</option>
                                <option value="Male" {% if details and details.gender == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if details and details.gender == 'Female' %}selected{% endif %}>Female</option>
                                <option value="Prefer not to say" {% if details and details.gender == 'Prefer not to say' %}selected{% endif %}>Prefer not to say</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" name="phone" value="{{ details.phone if details and details.phone else '' }}" pattern="^09[0-9]{9}$" title="Enter a valid Philippine mobile number starting with 09 (11 digits total)" inputmode="numeric" maxlength="11" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                        <p id="phone-error" class="text-sm text-red-600 mt-1" style="display:none;">Please enter a valid Philippine mobile number starting with 09 (11 digits).</p>
                    </div>

                    <div class="mb-6">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address <span class="text-red-500">*</span></label>
                        <input type="email" id="email" name="email" value="{{ details.email if details and details.email else (session.user_email if session.user_email is defined else '') }}" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="mt-8 pt-6 border-t flex justify-between items-center">
                        {%- set appt_type = session.appointment_details.appointment_type if session.appointment_details and session.appointment_details.appointment_type else '' -%}
                        {% if appt_type == 'consultation' %}
                            <a href="{{ url_for('book_appointment') }}" class="text-gray-600 hover:text-gray-900 font-medium">
                                <i class="fas fa-arrow-left mr-2"></i> Go Back
                            </a>
                        {% else %}
                            <a href="{{ url_for('book_appointment_datetime') }}" class="text-gray-600 hover:text-gray-900 font-medium">
                                <i class="fas fa-arrow-left mr-2"></i> Go Back
                            </a>
                        {% endif %}
                        <button type="submit" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-red-700 transition-colors">
                            Next
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>
    <script>
        // Compute age in years from a YYYY-MM-DD date string and populate hidden age input
        function computeAgeFromDOB(dobStr) {
            if (!dobStr) return null;
            const parts = dobStr.split('-');
            if (parts.length !== 3) return null;
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            const today = new Date();
            let age = today.getFullYear() - year;
            if ((today.getMonth() + 1) < month || ((today.getMonth() + 1) === month && today.getDate() < day)) {
                age -= 1;
            }
            return age;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const dobInput = document.getElementById('date_of_birth');
            const ageHidden = document.getElementById('age');
            const ageYears = document.getElementById('age_years');
            const phoneInput = document.getElementById('phone');
            const phoneError = document.getElementById('phone-error');

            // Phone validation helper
            function validatePhilippinePhone(value) {
                if (!value) return false;
                // Normalize: remove spaces, dashes
                const v = value.replace(/[^0-9]/g, '');
                return /^09\d{9}$/.test(v);
            }

            // Real-time phone validation
            if (phoneInput) {
                phoneInput.addEventListener('input', function() {
                    const valid = validatePhilippinePhone(this.value);
                    if (!valid) {
                        phoneError.style.display = 'block';
                    } else {
                        phoneError.style.display = 'none';
                    }
                });
                // Initial validation on load
                if (!validatePhilippinePhone(phoneInput.value)) {
                    phoneError.style.display = phoneInput.value ? 'block' : 'none';
                }
            }

            function updateAgeDisplay() {
                const dob = dobInput.value;
                const age = computeAgeFromDOB(dob);
                if (age === null || isNaN(age)) {
                    ageYears.textContent = '--';
                    ageHidden.value = '';
                } else {
                    ageYears.textContent = age;
                    ageHidden.value = age;
                }
            }

            dobInput.addEventListener('change', updateAgeDisplay);
            // Initialize if value present (e.g., browser autofill/back)
            updateAgeDisplay();
        });
    </script>
</body>
</html>
