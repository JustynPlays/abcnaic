{% extends "admin_base.html" %}

{% block title %}Appointment Details - {{ appointment.patient_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <style>
        /* Print only the appointment details card */
        @media print {
            body * { visibility: hidden !important; }
            #appointment-printable, #appointment-printable * { visibility: visible !important; }
            #appointment-printable { position: absolute !important; left: 0; top: 0; width: 100% !important; }
        }
    </style>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Appointment Details</h1>
        <div>
            <a href="{{ url_for('appointments.list_appointments') }}" class="btn btn-sm btn-secondary me-2">
                <i class="fas fa-arrow-left fa-sm"></i> Back to Appointments
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Appointment Details Card -->
            <div id="appointment-printable" class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold" style="color: #e84118;">Appointment Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Basic Information</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Patient Name:</strong></td>
                                    <td>{{ appointment.patient_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Service:</strong></td>
                                    <td>{{ appointment.service }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        <span class="badge bg-{% if appointment.status == 'confirmed' %}success{% elif appointment.status == 'completed' %}info{% elif appointment.status == 'cancelled' %}danger{% else %}warning{% endif %}">
                                            {{ appointment.status | capitalize }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Price:</strong></td>
                                    <td>â‚±{{ "%.2f"|format(appointment.price) }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Appointment Details</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Date & Time:</strong></td>
                                    <td>{{ appointment.appointment_date }} at {{ appointment.appointment_time }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Booked By:</strong></td>
                                    <td>{{ appointment.user_name }} ({{ appointment.user_email }})</td>
                                </tr>
                                {% if appointment.status == 'completed' %}
                                <tr>
                                    <td><strong>Completed:</strong></td>
                                    <td>{{ appointment.updated_at.split('T')[0] if appointment.updated_at else 'N/A' }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Animal & Bite Information</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Animal Type:</strong></td>
                                    <td>
                                        {%- if appointment.animal_type -%}
                                            {%- if appointment.animal_type == 'etc' and appointment.animal_etc_text -%}
                                                {{ appointment.animal_type | upper }} - {{ appointment.animal_etc_text }}
                                            {%- else -%}
                                                {{ appointment.animal_type or 'N/A' }}
                                            {%- endif -%}
                                        {%- else -%}
                                            N/A
                                        {%- endif -%}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Bite Location:</strong></td>
                                    <td>{{ appointment.bite_location or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Exposure Type:</strong></td>
                                    <td>{{ appointment.exposure_type or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Category:</strong></td>
                                    <td>{{ appointment.category or 'N/A' }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Patient Information</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Age:</strong></td>
                                    <td>{{ appointment.patient_age or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Gender:</strong></td>
                                        <td>{{ appointment.patient_gender|capitalize or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>{{ appointment.patient_phone or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{ appointment.patient_email or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td>{{ appointment.patient_address or 'N/A' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold" style="color: #e84118;">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if appointment.status != 'completed' %}
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#categoryModal">
                            <i class="fas fa-edit me-2"></i>Update Category
                        </button>
                        {% endif %}

                        {% if appointment.status not in ['completed', 'cancelled'] %}
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#statusModal">
                            <i class="fas fa-exchange-alt me-2"></i>Update Status
                        </button>
                        {% endif %}

                        <button class="btn btn-outline-danger" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>Print Details
                        </button>
                        
                        <!-- Send SMS Notification -->
                        <button id="smsBtn" type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#smsModal">
                            <i class="fas fa-sms me-2"></i>Send SMS
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Badge -->
            <div class="card shadow mb-4">
                <div class="card-body text-center">
                    <h5>Current Status</h5>
                    <span class="badge fs-6 p-3 bg-{% if appointment.status == 'confirmed' %}success{% elif appointment.status == 'completed' %}info{% elif appointment.status == 'cancelled' %}danger{% else %}warning{% endif %}">
                        {{ appointment.status | capitalize }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">Update Appointment Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if appointment.status == 'completed' %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Status Update Not Available</strong><br>
                        Completed appointments cannot have their status changed.
                    </div>
                    {% else %}
                    <p>Update the status for appointment with <strong>{{ appointment.patient_name }}</strong></p>
                    <form action="{{ url_for('appointments.update_appointment_status', appointment_id=appointment.id) }}" method="post">
                        <div class="mb-3">
                            <label for="status" class="form-label">New Status</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="pending" {% if appointment.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="confirmed" {% if appointment.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                <option value="completed" {% if appointment.status == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="cancelled" {% if appointment.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-outline-danger">Update Status</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Category Update Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">Update Appointment Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if appointment.status == 'completed' %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Category Update Not Available</strong><br>
                        Completed appointments cannot have their category changed.
                    </div>
                    {% else %}
                    <p>Update the category for appointment with <strong>{{ appointment.patient_name }}</strong></p>
                    <form action="{{ url_for('appointments.update_appointment_category', appointment_id=appointment.id) }}" method="post">
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">-- Select Category --</option>
                                <option value="Category I" {% if appointment.category == 'Category I' %}selected{% endif %}>Category I</option>
                                <option value="Category II" {% if appointment.category == 'Category II' %}selected{% endif %}>Category II</option>
                                <option value="Category III" {% if appointment.category == 'Category III' %}selected{% endif %}>Category III</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-outline-danger">Update Category</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- SMS Modal -->
    <div class="modal fade" id="smsModal" tabindex="-1" aria-labelledby="smsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="smsModalLabel">Send SMS Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{{ url_for('appointments.send_sms_notification', appointment_id=appointment.id) }}">
                    <div class="modal-body">
                        <p>Send a notification to <strong>{{ appointment.patient_name }}</strong> at <strong>{{ appointment.patient_phone or 'N/A' }}</strong></p>

                        <div class="mb-3">
                            <label class="form-label">Template</label>
                            <select id="templateSelect" name="template_key" class="form-select">
                                <option value="__none__">-- Select Template --</option>
                                {% for key, tpl in sms_templates.items() %}
                                <option value="{{ key }}">{{ tpl.title or key }}</option>
                                {% endfor %}
                                <option value="__custom__">Custom Message</option>
                            </select>
                        </div>

                        <div id="templatePreview" class="mb-3" style="display:none;">
                            <label class="form-label">Preview</label>
                            <div class="card p-2"><pre id="previewText" style="white-space:pre-wrap;margin:0"></pre></div>
                        </div>

                        <div id="rescheduleFields" class="mb-3" style="display:none;">
                            <label class="form-label">New Date</label>
                            <input type="date" name="new_date" class="form-control">
                            <label class="form-label mt-2">New Time</label>
                            <input type="time" name="new_time" class="form-control">
                        </div>

                        <div id="customMessageField" class="mb-3" style="display:none;">
                            <label class="form-label">Custom Message</label>
                            <textarea name="custom_message" class="form-control" rows="4" placeholder="Type your message here..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send SMS</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function(){
    try {
        const smsTemplates = {{ sms_templates|tojson|default('{}')|safe }};

        function updateFields(){
            try {
                const sel = document.getElementById('templateSelect');
                const value = sel ? sel.value : '__none__';
                const reschedule = document.getElementById('rescheduleFields');
                const customField = document.getElementById('customMessageField');
                if (reschedule) reschedule.style.display = (value === 'reschedule') ? 'block' : 'none';
                if (customField) customField.style.display = (value === '__custom__') ? 'block' : 'none';
                const preview = document.getElementById('templatePreview');
                const previewText = document.getElementById('previewText');
                if (!preview || !previewText) return;
                if (!sel || value === '__none__'){
                    preview.style.display = 'none';
                    previewText.textContent = '';
                    return;
                }
                if (value === '__custom__'){
                    preview.style.display = 'none';
                    previewText.textContent = '';
                    return;
                }
                const tpl = smsTemplates[value];
                if (!tpl) return;
                const ctx = {
                    appointment_date: '{{ appointment.appointment_date }}',
                    appointment_time: '{{ appointment.appointment_time }}',
                    new_date: (document.querySelector('input[name="new_date"]') && document.querySelector('input[name="new_date"]').value) || '{{ appointment.appointment_date }}',
                    new_time: (document.querySelector('input[name="new_time"]') && document.querySelector('input[name="new_time"]').value) || '{{ appointment.appointment_time }}'
                };
                let text = tpl.body || '';
                Object.keys(ctx).forEach(function(k){
                    var re = new RegExp('\\{\\{\\s*' + k + '\\s*\\}\\}','g');
                    text = text.replace(re, ctx[k]);
                });
                preview.style.display = 'block';
                previewText.textContent = text;
            } catch (innerErr) {
                console.error('updateFields error', innerErr);
            }
        }
        const sel = document.getElementById('templateSelect');
        if (sel) sel.addEventListener('change', updateFields);
        var inputs = document.querySelectorAll('#rescheduleFields input');
        if (inputs && inputs.forEach) inputs.forEach(function(el){ el.addEventListener('change', updateFields); });
        updateFields();
    } catch (err) {
        console.error('SMS templates init error', err);
    }
});
</script>
<script>
(function(){
    try {
        console.log('SMS modal attach: searching for button...');
        const smsBtn = document.getElementById('smsBtn') || document.querySelector('.btn-outline-primary[data-bs-target="#smsModal"]') || document.querySelector('button[data-bs-target="#smsModal"]');
        console.log('SMS modal attach: found button?', !!smsBtn);
        if (!smsBtn) return;
        smsBtn.addEventListener('click', function(e){
            try {
                console.log('SMS button clicked');
                if (e && e.preventDefault) e.preventDefault();
                const modalEl = document.getElementById('smsModal');
                console.log('SMS modal element present?', !!modalEl);
                if (!modalEl) return;
                if (window.bootstrap && typeof bootstrap.Modal === 'function') {
                    console.log('Using bootstrap.Modal to show SMS modal');
                    const m = new bootstrap.Modal(modalEl);
                    m.show();
                } else if (modalEl.classList) {
                    console.log('Using fallback show for SMS modal');
                    modalEl.classList.add('show');
                    modalEl.style.display = 'block';
                    modalEl.removeAttribute('aria-hidden');
                } else {
                    console.warn('sms modal element has no classList, cannot show fallback');
                }
            } catch(err) { console.error('smsBtn click handler error', err); }
        });
    } catch(e) { console.error('sms modal attach error', e); }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    try {
        var smsModalEl = document.getElementById('smsModal');
        if (!smsModalEl) return;

        // When the modal is hidden, ensure any leftover backdrop or body classes are cleaned up
        smsModalEl.addEventListener('hidden.bs.modal', function(){
            try {
                document.querySelectorAll('.modal-backdrop').forEach(function(b){ b.remove(); });
                document.body.classList.remove('modal-open');
                // reset any body padding added by Bootstrap
                document.body.style.paddingRight = '';
            } catch (e) { console.error('cleanup hidden.bs.modal', e); }
        });

        // Fallback: some browsers or older script orders may not trigger bootstrap events reliably.
        // Hook close buttons inside the modal to force a cleanup when clicked.
        smsModalEl.querySelectorAll('[data-bs-dismiss="modal"]').forEach(function(btn){
            btn.addEventListener('click', function(){
                try {
                    if (window.bootstrap && bootstrap.Modal && bootstrap.Modal.getInstance) {
                        var inst = bootstrap.Modal.getInstance(smsModalEl);
                        if (inst) inst.hide();
                    } else {
                        smsModalEl.classList.remove('show');
                        smsModalEl.style.display = 'none';
                        smsModalEl.setAttribute('aria-hidden', 'true');
                        document.querySelectorAll('.modal-backdrop').forEach(function(b){ b.remove(); });
                        document.body.classList.remove('modal-open');
                        document.body.style.paddingRight = '';
                    }
                } catch(e) { console.error('close button cleanup', e); }
            });
        });

        // When modal is shown, make sure duplicate backdrops don't accumulate
        smsModalEl.addEventListener('shown.bs.modal', function(){
            try {
                var backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 1) {
                    backdrops.forEach(function(b, i){ if (i>0) b.remove(); });
                }
            } catch(e) { console.error('shown.bs.modal cleanup', e); }
        });
    } catch(err) {
        console.error('SMS modal robust cleanup init error', err);
    }
});
</script>
{% endblock %}
