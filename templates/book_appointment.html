<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book an Appointment - Dr. Care Animal Bite Center Naic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/user_responsive.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .mandatory-badge {
            background: linear-gradient(135deg,#c41e3a,#b20000);
            color: white; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight:600;
        }
        .service-card.mandatory { border-left: 4px solid #c41e3a; box-shadow: 0 4px 12px rgba(196,30,58,0.06); }
        .service-card .checked-mark { color: #c41e3a; font-weight:700; margin-right:0.5rem; }
        .sidebar-link.active {
            background-color: #FEF2F2; /* red-50 */
            color: #A52A2A; /* maroon */
            font-weight: 600;
            border-right: 4px solid #A52A2A;
        }
        .sidebar-link.completed {
            background-color: rgba(165,42,42,0.05);
            color: #A52A2A;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <a href="{{ url_for('home') }}" class="text-red-600 bg-white border-2 border-red-600 rounded-full w-12 h-12 flex items-center justify-center shadow-md hover:bg-red-50 transition">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-800">Book an Appointment</h1>
            <div class="w-12"></div> <!-- Spacer -->
        </header>

        <!-- Main Content -->
        <script>
            // If the server-side session recorded appointment_type as 'consultation', skip this page.
            // The hidden input `appointment_type_input` is populated by Jinja; if it's consultation,
            // the client should navigate to the datetime step automatically as a UX guard.
            document.addEventListener('DOMContentLoaded', function() {
                try {
                    var at = document.getElementById('appointment_type_input');
                    if (at && at.value === 'consultation') {
                        // Minor delay to allow any pending JS to run, then redirect.
                        setTimeout(function() { window.location.href = "{{ url_for('book_appointment_datetime') }}"; }, 50);
                    }
                } catch (e) {
                    console.log('DEBUG: error in consultation redirect guard', e);
                }
            });
        </script>
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Left Sidebar -->
            <aside class="w-full md:w-1/4">
                <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                    <!-- Step 1: Type -->
                    <div class="flex items-center p-3 text-gray-500 rounded-lg cursor-default">
                        <i class="fas fa-list-alt fa-fw mr-3"></i> Type
                    </div>
                    <!-- Current Step - Not clickable -->
                    <div class="sidebar-link active flex items-center p-3 text-gray-600 rounded-lg cursor-default">
                        <i class="fas fa-pills fa-fw mr-3"></i> Services & Fees
                    </div>
                    <!-- Upcoming Steps - Not clickable and faded -->
                    <div class="flex items-center p-3 mt-2 text-gray-400 rounded-lg cursor-default">
                        <i class="fas fa-calendar fa-fw mr-3"></i> Date & Time
                    </div>
                    <div class="flex items-center p-3 mt-2 text-gray-400 rounded-lg cursor-default">
                        <i class="fas fa-user-edit fa-fw mr-3"></i> Details
                    </div>
                    <div class="flex items-center p-3 mt-2 text-gray-400 rounded-lg cursor-default">
                        <i class="fas fa-file-alt fa-fw mr-3"></i> Summary
                    </div>
                </div>
            </aside>

            <!-- Right Content -->
            <main class="w-full md:w-3/4">
                <form action="{{ url_for('book_appointment_services') }}" method="POST" class="bg-white p-8 rounded-lg shadow-md border border-gray-200">
                    <!-- Persist appointment type from previous step for client-side validation -->
                    <input type="hidden" id="appointment_type_input" name="appointment_type" value="{{ session.appointment_details.appointment_type if session.appointment_details and session.appointment_details.appointment_type else '' }}">
                    <!-- Server applied services (comma-separated) for client-side UI behaviors -->
                    <input type="hidden" id="server_applied_services" value="{{ session.appointment_details.service if session.appointment_details and session.appointment_details.service else '' }}">
                    {# Prepare a normalized list of services from the session so we can pre-check inputs when user navigates back #}
                    {% set server_services = session.appointment_details.service.split(',')|map('trim')|map('lower')|list if session.appointment_details and session.appointment_details.service else [] %}
                    <!-- Two Column Layout for Form Content -->
                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Left Column - Form Fields -->
                        <div class="w-full lg:w-1/2">
                            <!-- Applied Vaccines (auto-applied) -->
                            {% if session.appointment_details and session.appointment_details.appointment_type == 'vaccination' and session.appointment_details.service %}
                            <div id="applied-vaccines" class="mb-6 bg-red-50 p-4 rounded-md border border-red-100">
                                <h4 class="font-semibold text-lg text-red-700 mb-2">Applied Vaccines</h4>
                                <p class="text-sm text-gray-700">The following vaccines have been automatically applied based on your selection:</p>
                                <ul class="mt-2 list-disc list-inside text-sm text-gray-800">
                                    {% for s in session.appointment_details.service.split(',') %}
                                        {%- set sname = s.strip() -%}
                                        <li class="applied-vaccine-item">{{ sname }}</li>
                                    {% endfor %}
                                </ul>
                                <p class="mt-2 text-xs text-gray-500">You can review these on the summary page.</p>
                            </div>
                            {% endif %}
                            <!-- Appointment Type (chosen on previous step) -->
                            <div class="mb-4">
                                <h4 class="text-sm text-gray-600">Selected: <strong>{{ session.appointment_details.appointment_type if session.appointment_details and session.appointment_details.appointment_type else 'Not selected' }}</strong></h4>
                            </div>

                            <!-- Type of Animal -->
                            <div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2">Type of Animal</h3>
                                <div class="flex items-center gap-6">
                                    <label class="flex items-center"><input type="radio" name="animal_type" value="dog" class="form-radio text-red-600" required {% if session.appointment_details and session.appointment_details.animal_type=='dog' %}checked{% endif %}> <span class="ml-2">DOG</span></label>
                                    <label class="flex items-center"><input type="radio" name="animal_type" value="cat" class="form-radio text-red-600" required {% if session.appointment_details and session.appointment_details.animal_type=='cat' %}checked{% endif %}> <span class="ml-2">CAT</span></label>
                                    <label class="flex items-center">
                                        <input type="radio" name="animal_type" value="etc" class="form-radio text-red-600 animal-etc-radio" required {% if session.appointment_details and session.appointment_details.animal_type=='etc' %}checked{% endif %}>
                                        <span class="ml-2">ETC</span>
                                    </label>
                                </div>
                                <!-- Text input for ETC option -->
                                <div class="mt-3 animal-etc-input" style="display: none;">
                                    <label for="animal_etc_text" class="block text-sm font-medium text-gray-700 mb-1">Please specify the animal:</label>
                                    <input type="text" id="animal_etc_text" name="animal_etc_text" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="e.g., Monkey, Snake, etc.">
                                </div>
                            </div>

                            <!-- Type of Exposure -->
                            <div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2">Type of Exposure</h3>
                                <div class="flex items-center gap-6">
                                        <label class="flex items-center"><input type="radio" name="exposure_type" value="bite" class="form-radio text-red-600" {% if session.appointment_details and session.appointment_details.exposure_type=='bite' %}checked{% endif %}> <span class="ml-2">BITE</span></label>
                                        <label class="flex items-center"><input type="radio" name="exposure_type" value="scratch" class="form-radio text-red-600" {% if session.appointment_details and session.appointment_details.exposure_type=='scratch' %}checked{% endif %}> <span class="ml-2">SCRATCH</span></label>
                                </div>
                            </div>

                            <!-- Services Offered -->
                            <div class="services-offered-container">
                                <h3 class="font-semibold text-lg mb-6">Services Offered</h3>

                                <!-- Dynamic Services from Database -->
                                {% if services %}
                                    <!-- Vaccination Services -->
                                    {% if vaccination_services %}
                                    <div class="mb-6 vaccination-section">
                                        <h4 class="font-medium text-md mb-3 text-red-600 bg-red-50 p-2 rounded-md">
                                            <i class="fas fa-syringe mr-2"></i>Vaccination Services
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {% for service in vaccination_services %}
                                            <label class="border border-gray-300 rounded-lg p-4 flex items-center gap-4 cursor-pointer hover:bg-red-50 has-[:checked]:bg-red-50 has-[:checked]:border-red-400">
                                                <input type="{{ 'checkbox' if session.appointment_details and session.appointment_details.appointment_type == 'vaccination' else 'radio' }}" name="service" value="{{ service.name }}" class="form-radio h-5 w-5 text-red-600 border-gray-400 focus:ring-red-500" {% if not (session.appointment_details and session.appointment_details.appointment_type == 'vaccination') %}required{% endif %} {% if service.name|lower in server_services %}checked{% endif %}>
                                                <i class="fas fa-syringe fa-2x text-red-500"></i>
                                                <div>
                                                    <p class="font-semibold">{{ service.name }}</p>
                                                    <p class="text-sm text-gray-600">Price: ₱{{ "%.2f"|format(service.price) }}</p>
                                                </div>
                                            </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Consultation services are handled automatically; users do not select them here. -->
                                {% else %}
                                    <!-- Fallback hardcoded services if no database services -->
                                    <!-- Vaccination Services -->
                                    <div class="mb-6 vaccination-section">
                                        <h4 class="font-medium text-md mb-3 text-red-600 bg-red-50 p-2 rounded-md">
                                            <i class="fas fa-syringe mr-2"></i>Vaccination Services
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <label class="border border-gray-300 rounded-lg p-4 flex items-center gap-4 cursor-pointer hover:bg-red-50 has-[:checked]:bg-red-50 has-[:checked]:border-red-400">
                                                <input type="{{ 'checkbox' if session.appointment_details and session.appointment_details.appointment_type == 'vaccination' else 'radio' }}" name="service" value="Anti-Rabies Vaccine" class="form-radio h-5 w-5 text-red-600 border-gray-400 focus:ring-red-500" {% if not (session.appointment_details and session.appointment_details.appointment_type == 'vaccination') %}required{% endif %} {% if 'anti-rabies vaccine' in server_services or 'anti-rabies' in server_services %}checked{% endif %}>
                                                <i class="fas fa-syringe fa-2x text-red-500"></i>
                                                <div>
                                                    <p class="font-semibold">Anti-Rabies Vaccine</p>
                                                    <p class="text-sm text-gray-600">Price: ₱425.00</p>
                                                </div>
                                            </label>
                                            <label class="border border-gray-300 rounded-lg p-4 flex items-center gap-4 cursor-pointer hover:bg-red-50 has-[:checked]:bg-red-50 has-[:checked]:border-red-400">
                                                <input type="{{ 'checkbox' if session.appointment_details and session.appointment_details.appointment_type == 'vaccination' else 'radio' }}" name="service" value="Tetanus Toxoid" class="form-radio h-5 w-5 text-red-600 border-gray-400 focus:ring-red-500" {% if not (session.appointment_details and session.appointment_details.appointment_type == 'vaccination') %}required{% endif %} {% if 'tetanus toxoid' in server_services or 'tetanus' in server_services %}checked{% endif %}>
                                                <i class="fas fa-syringe fa-2x text-red-500"></i>
                                                <div>
                                                    <p class="font-semibold">Tetanus Toxoid</p>
                                                    <p class="text-sm text-gray-600">Price: ₱150.00</p>
                                                </div>
                                            </label>
                                            <label class="border border-gray-300 rounded-lg p-4 flex items-center gap-4 cursor-pointer hover:bg-red-50 has-[:checked]:bg-red-50 has-[:checked]:border-red-400">
                                                <input type="{{ 'checkbox' if session.appointment_details and session.appointment_details.appointment_type == 'vaccination' else 'radio' }}" name="service" value="ERIG Vaccine" class="form-radio h-5 w-5 text-red-600 border-gray-400 focus:ring-red-500" {% if not (session.appointment_details and session.appointment_details.appointment_type == 'vaccination') %}required{% endif %} {% if 'erig vaccine' in server_services or 'erig' in server_services %}checked{% endif %}>
                                                <i class="fas fa-syringe fa-2x text-red-500"></i>
                                                <div>
                                                    <p class="font-semibold">ERIG Vaccine</p>
                                                    <p class="text-sm text-gray-600">Price: ₱1,200.00 (Infiltration)</p>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Consultation services omitted (automated by system) -->
                                {% endif %}
                            </div>
                        </div>

                        <!-- Right Column - Bite/Scratch Location -->
                        <div class="w-full lg:w-1/2">
                            <!-- Bite/Scratch Location - Interactive Body Diagram -->
                            <div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2">Bite/Scratch Location <span class="text-red-500">*</span></h3>
                                <p class="text-sm text-gray-600 mb-4">First select whether this was a bite or scratch above, then click on the body parts where you were bitten or scratched:</p>

                                <!-- Hidden inputs to store selected body parts with exposure type. Prefill from session so selections persist when going back -->
                                <input type="hidden" id="body_diagram_selection" name="body_diagram_selection" value="{{ session.appointment_details.bite_location if session.appointment_details and session.appointment_details.bite_location else '' }}">
                                <input type="hidden" id="exposure_type" name="exposure_type" value="{{ session.appointment_details.exposure_type if session.appointment_details and session.appointment_details.exposure_type else '' }}">

                                <div class="body-diagram-container">
                                    <div class="body-diagram-wrapper" style="display: flex; flex-direction: row; gap: 2rem; align-items: flex-start; justify-content: center; flex-wrap: wrap;">
                                        <div class="body-diagram" style="flex-shrink: 0; width: 420px; background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 1px solid #e9ecef; display: flex; justify-content: center; margin-bottom: 1rem;">
                                            <!-- Inline SVG for interactivity -->
                                            <svg width="100%" height="700" viewBox="0 0 400 700" xmlns="http://www.w3.org/2000/svg" style="max-width: 400px;">
                                              <defs>
                                                <style>
                                                  .body-part {
                                                    fill: #fdd1a1;
                                                    stroke: #a5522a;
                                                    stroke-width: 2;
                                                    cursor: pointer;
                                                    transition: all 0.2s ease-in-out;
                                                  }
                                                  .body-part:hover {
                                                    fill: #fbc28d;
                                                    stroke-width: 3;
                                                  }
                                                  .body-part.selected {
                                                    fill: #c41e3a;
                                                    stroke: #8b1020;
                                                    stroke-width: 3;
                                                  }
                                                  .label {
                                                    font-family: 'Segoe UI', Arial, sans-serif;
                                                    font-size: 12px;
                                                    fill: #333;
                                                    text-anchor: middle;
                                                    pointer-events: none;
                                                    font-weight: 500;
                                                  }
                                                </style>
                                              </defs>

                                              <!-- Background -->
                                              <rect width="400" height="700" fill="#f8f9fa"/>

                                              <!-- Human-Like Body Diagram -->
                                              <g id="human-body">
                                                <!-- Head -->
                                                <path id="head" class="body-part" data-part="head" d="M199.5,30 C174.6,30 155,54.6 155,80 C155,105.4 174.6,125 199.5,125 C224.4,125 244,105.4 244,80 C244,54.6 224.4,30 199.5,30 Z"/>
                                                <text x="200" y="25" class="label">Head</text>

                                                <!-- Neck -->
                                                <path id="neck" class="body-part" data-part="neck" d="M185,123 C185,130 180,140 180,145 L220,145 C220,140 215,130 215,123 Z"/>
                                                <text x="200" y="155" class="label">Neck</text>

                                                <!-- Chest -->
                                                <path id="chest" class="body-part" data-part="chest" d="M165,146 C140,160 130,200 145,220 C150,210 160,205 175,205 L225,205 C240,205 250,210 255,220 C270,200 260,160 235,146 C220,140 180,140 165,146 Z"/>
                                                <text x="200" y="180" class="label">Chest</text>

                                                <!-- Abdomen -->
                                                <path id="abdomen" class="body-part" data-part="abdomen" d="M165,220 C140,230 130,270 145,300 C150,295 160,290 175,290 L225,290 C240,290 250,295 255,300 C270,270 260,230 235,220 C220,215 180,215 165,220 Z"/>
                                                <text x="200" y="270" class="label">Abdomen</text>

                                                <!-- Pelvis -->
                                                <path id="pelvis" class="body-part" data-part="pelvis" d="M175,300 C155,300 140,320 145,340 C150,350 165,355 180,355 L220,355 C235,355 250,350 255,340 C260,320 245,300 225,300 Z"/>
                                                <text x="200" y="330" class="label">Pelvis</text>

                                                <!-- Left Upper Arm -->
                                                <g id="left-arm">
                                                  <path id="left-upper-arm" class="body-part" data-part="left-upper-arm" d="M164,146 C150,155 120,175 110,235 C108,245 115,255 125,253 C135,250 145,195 160,155 Z"/>
                                                  <path id="left-forearm" class="body-part" data-part="left-forearm" d="M110,237 C100,275 95,315 105,345 L120,350 C130,315 125,275 125,253 Z"/>
                                                  <path id="left-hand" class="body-part" data-part="left-hand" d="M105,345 C90,355 85,375 95,395 C105,405 120,395 120,380 C120,365 115,350 105,345 Z"/>
                                                  <text x="90" y="195" class="label">Left Upper Arm</text>
                                                  <text x="80" y="300" class="label">Left Forearm</text>
                                                  <text x="70" y="375" class="label">Left Hand</text>
                                                </g>

                                                <!-- Right Upper Arm -->
                                                <g id="right-arm">
                                                  <path id="right-upper-arm" class="body-part" data-part="right-upper-arm" d="M236,146 C250,155 280,175 290,235 C292,245 285,255 275,253 C265,250 255,195 240,155 Z"/>
                                                  <path id="right-forearm" class="body-part" data-part="right-forearm" d="M290,237 C300,275 305,315 295,345 L280,350 C270,315 275,275 275,253 Z"/>
                                                  <path id="right-hand" class="body-part" data-part="right-hand" d="M295,345 C310,355 315,375 305,395 C295,405 280,395 280,380 C280,365 285,350 295,345 Z"/>
                                                  <text x="310" y="195" class="label">Right Upper Arm</text>
                                                  <text x="320" y="300" class="label">Right Forearm</text>
                                                  <text x="330" y="375" class="label">Right Hand</text>
                                                </g>

                                                <!-- Left Thigh -->
                                                <g id="left-leg">
                                                  <path id="left-thigh" class="body-part" data-part="left-thigh" d="M175,355 C160,360 145,410 150,460 L175,465 C180,410 185,360 175,355 Z"/>
                                                  <path id="left-lower-leg" class="body-part" data-part="left-lower-leg" d="M155,460 C150,500 155,550 165,580 L180,575 C175,550 170,500 175,465 Z"/>
                                                  <path id="left-foot" class="body-part" data-part="left-foot" d="M165,580 C155,590 155,610 170,615 C185,610 185,590 180,575 Z"/>
                                                  <text x="130" y="410" class="label">Left Thigh</text>
                                                  <text x="120" y="520" class="label">Left Lower Leg</text>
                                                  <text x="110" y="600" class="label">Left Foot</text>
                                                </g>

                                                <!-- Right Thigh -->
                                                <g id="right-leg">
                                                  <path id="right-thigh" class="body-part" data-part="right-thigh" d="M225,355 C240,360 255,410 250,460 L225,465 C220,410 215,360 225,355 Z"/>
                                                  <path id="right-lower-leg" class="body-part" data-part="right-lower-leg" d="M245,460 C250,500 245,550 235,580 L220,575 C225,550 230,500 225,465 Z"/>
                                                  <path id="right-foot" class="body-part" data-part="right-foot" d="M235,580 C245,590 245,610 230,615 C215,610 215,590 220,575 Z"/>
                                                  <text x="270" y="410" class="label">Right Thigh</text>
                                                  <text x="280" y="520" class="label">Right Lower Leg</text>
                                                  <text x="290" y="600" class="label">Right Foot</text>
                                                </g>
                                              </g>

                                              <!-- Instructions -->
                                              <text x="200" y="650" class="label" style="font-size: 13px; fill: #666;">First select bite or scratch above, then click body parts</text>
                                              <text x="200" y="670" class="label" style="font-size: 11px; fill: #999;">Click specific areas for precise injury location</text>
                                            </svg>
                                        </div>
                                        <div class="selected-parts" style="min-width: 320px; max-width: 400px; flex-shrink: 0; background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 1px solid #e9ecef;">
                                            <h4 style="color: #b20000; font-weight: 600; margin: 0 0 1rem 0; font-size: 1.1rem;">Selected Areas</h4>
                                            <div id="selected-body-parts">
                                                <div class="text-center py-4">
                                                    <p class="text-muted mb-2">No body parts selected</p>
                                                    <small class="text-gray-500">Click on the body diagram to select where you were bitten or scratched</small>
                                                </div>
                                            </div>
                                            <button type="button" id="clear-body-parts" class="clear-button">
                                                Clear All Selections
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Next Button - Outside columns, at bottom right -->
                    </div>

                    <!-- Next Button -->
                    <div class="mt-8 pt-6 border-t flex justify-between items-center">
                        <a href="{{ url_for('book_appointment') }}" class="text-gray-600 hover:text-gray-900 font-medium"><i class="fas fa-arrow-left mr-2"></i>Go Back</a>
                        <button type="submit" id="next-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition disabled:bg-gray-300 disabled:text-gray-600 disabled:opacity-80 disabled:cursor-not-allowed" disabled>
                            Next
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

        <script>
        // Initialize body diagram functionality
        document.addEventListener('DOMContentLoaded', function() {
            const bodyParts = document.querySelectorAll('.body-part');
            const selectedPartsContainer = document.getElementById('selected-body-parts');
            const bodyDiagramInput = document.getElementById('body_diagram_selection');
            const exposureTypeInput = document.getElementById('exposure_type');
            const exposureRadios = document.querySelectorAll('input[name="exposure_type"]');
            const nextBtn = document.getElementById('next-btn');
            const animalRadios = document.querySelectorAll('input[name="animal_type"]');
            const serviceRadios = document.querySelectorAll('input[name="service"]');
            const etcInput = document.querySelector('.animal-etc-input');
            const etcTextInput = document.getElementById('animal_etc_text');
            let selectedParts = [];
            let currentExposureType = '';
            // Read server-applied services
            const serverServicesRaw = document.getElementById('server_applied_services') ? document.getElementById('server_applied_services').value : '';
            const serverServices = serverServicesRaw ? serverServicesRaw.split(',').map(s => s.trim()) : [];
            const normalizedServerServices = serverServices.map(s => (s || '').toLowerCase());

            // When appointment type is vaccination, mark mandatory vaccines. If radios for those vaccines exist, check them.
            try {
                const appointmentTypeVal = document.getElementById('appointment_type_input') ? document.getElementById('appointment_type_input').value : '';
                if (appointmentTypeVal === 'vaccination') {
                    // For each service radio, if it matches a server-applied service, check it and mark mandatory
                    document.querySelectorAll('input[name="service"]').forEach(r => {
                        const label = r.closest('label');
                        if (serverServices.includes(r.value)) {
                            // mark as checked (server-applied) and visually mandatory
                            try { r.checked = true; } catch(e) {}
                            if (label) label.classList.add('mandatory', 'service-card');
                        }
                    });
                }
            } catch (e) { console.log('DEBUG: error initializing server-applied vaccines', e); }

            // Also ensure mandatory vaccines are checked client-side for vaccination flows
            try {
                const appointmentTypeVal2 = document.getElementById('appointment_type_input') ? document.getElementById('appointment_type_input').value : '';
                if (appointmentTypeVal2 === 'vaccination') {
                    document.querySelectorAll('input[name="service"]').forEach(r => {
                        const val = (r.value || '').toLowerCase();
                        if (val.includes('rabies') || val.includes('tetanus')) {
                            // force-check mandatory vaccines and mark label
                            try { r.checked = true; } catch(e) {}
                            const label = r.closest('label');
                            if (label) {
                                label.classList.add('mandatory', 'service-card');
                            }
                        }
                    });
                }
            } catch (e) { console.log('DEBUG: error forcing mandatory vaccine checks', e); }

            // Prevent user interaction on vaccination-applied services while keeping the inputs enabled (so checks look normal)
            try {
                const atInput = document.getElementById('appointment_type_input');
                const isVacc = atInput && atInput.value === 'vaccination';
                document.querySelectorAll('input[name="service"]').forEach(inp => {
                    const val = (inp.value || '').trim();
                    const isServerApplied = serverServices.includes(val);
                    if (isVacc || isServerApplied) {
                        // prevent mouse clicks
                        inp.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        // prevent keyboard toggles (space/enter)
                        inp.addEventListener('keydown', function(e) {
                            if (e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter') {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                        });
                        // also prevent label clicks that would toggle
                        const lab = inp.closest('label');
                        if (lab) {
                            lab.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                            });
                        }
                    }
                });
            } catch (e) { console.log('DEBUG: error preventing service input interaction', e); }

                // Form validation function
            function validateForm() {
                if (!nextBtn) return;

                const animalType = document.querySelector('input[name="animal_type"]:checked');
                const exposureType = document.querySelector('input[name="exposure_type"]:checked');
                const service = document.querySelector('input[name="service"]:checked');
                const bodyPartsSelected = selectedParts.length > 0;
                const appointmentTypeRadio = document.querySelector('input[name="appointment_type"]:checked');
                const appointmentType = appointmentTypeRadio ? appointmentTypeRadio.value : (document.getElementById('appointment_type_input') ? document.getElementById('appointment_type_input').value : '');

                // Check if ETC is selected and text is provided
                let etcValid = true;
                if (animalType && animalType.value === 'etc') {
                    etcValid = etcTextInput && etcTextInput.value.trim() !== '';
                }

                // Compute separate validity for vaccination vs consultation
                // For vaccination flows, service may be auto-applied by the server and not selected as a radio.
                // We'll treat vaccination as valid if animalType, exposureType, bodyParts and etc (if required) are present
                // OR if the server has already applied services (session contains them).
                const serverAppliedServices = (document.querySelector('#applied-vaccines') || null);
                const vaccValid = animalType && exposureType && bodyPartsSelected && etcValid;
                const consultValid = animalType && service && etcValid;

                // If appointment type is vaccination, accept vaccValid OR server-applied services being present
                let isValidVaccFromServer = false;
                try {
                    const atInput = document.getElementById('appointment_type_input');
                    if (atInput && atInput.value === 'vaccination') {
                        // Check whether session-injected service list exists in the DOM
                        const appliedList = document.querySelectorAll('.applied-vaccine-item');
                        if (appliedList && appliedList.length > 0) isValidVaccFromServer = true;
                        // Also consider manual checkbox selections for vaccination (multiple checkboxes)
                        const checkedServices = Array.from(document.querySelectorAll('input[name="service"]:checked'));
                        if (checkedServices && checkedServices.length > 0) isValidVaccFromServer = true;
                    }
                } catch (e) {
                    console.log('DEBUG: error checking server-applied vaccines', e);
                }

                let isValid = false;
                if (appointmentType === 'vaccination') {
                    // Vaccination flows require body part selection; server-applied services do not bypass this.
                    isValid = !!(vaccValid);
                } else if (appointmentType === 'consultation') {
                    isValid = !!consultValid;
                } else {
                    // No appointment type available (user might have navigated directly) - accept either path,
                    // but require body parts for vaccination when possible
                    isValid = !!(vaccValid || consultValid || isValidVaccFromServer);
                }

                nextBtn.disabled = !isValid;
            }

            // Initialize selected parts from hidden input if exists
            if (bodyDiagramInput && bodyDiagramInput.value) {
                selectedParts = bodyDiagramInput.value.split(',').filter(part => part.trim());
                // reflect selection on the SVG body diagram as well
                selectedParts.forEach(p => {
                    try {
                        // elements sometimes have ids like 'head' or 'left-hand'
                        const el = document.querySelector('[data-part="' + p + '"]') || document.getElementById(p);
                        if (el) el.classList.add('selected');
                    } catch (e) {}
                });
                updateSelectedParts();
                // After rehydration, ensure ERIG vaccine state matches the selected parts (head -> ERIG checked).
                try {
                    const normalizedServerServices = serverServices.map(s => (s || '').toLowerCase());
                    const hasHead = selectedParts.some(p => p.toLowerCase().includes('head'));
                    const erigRadio = Array.from(document.querySelectorAll('input[name="service"]')).find(i => i.value && i.value.toLowerCase().includes('erig'));
                    if (erigRadio) {
                        const lab = erigRadio.closest('label');
                        if (hasHead) {
                            try { erigRadio.checked = true; } catch(e) {}
                            if (lab) lab.classList.add('mandatory', 'service-card');
                        } else {
                            // Only uncheck if ERIG was NOT server-applied
                            if (!normalizedServerServices.includes('erig') && !normalizedServerServices.includes('erig vaccine')) {
                                try { erigRadio.checked = false; } catch(e) {}
                                if (lab) lab.classList.remove('mandatory', 'service-card');
                            }
                        }
                    }
                } catch (e) { console.log('DEBUG: error rehydrating ERIG state', e); }
            }

            // Track exposure type selection
            exposureRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    currentExposureType = this.value;
                    exposureTypeInput.value = currentExposureType;
                    validateForm();
                });
            });

            // Track appointment type selection (new)
            const appointmentRadios = document.querySelectorAll('input[name="appointment_type"]');
            appointmentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // persist into hidden input for server submission
                    document.getElementById('appointment_type_input').value = this.value;

                    // If consultation, hide the body diagram and exposure options
                    const bodyDiagramContainer = document.querySelector('.body-diagram-container');
                    const exposureSection = document.querySelector('input[name="exposure_type"]') ? document.querySelector('[name="exposure_type"]').closest('.mb-6') : null;
                    if (this.value === 'consultation') {
                        if (bodyDiagramContainer) bodyDiagramContainer.style.display = 'none';
                        // clear selected parts
                        selectedParts = [];
                        if (bodyDiagramInput) bodyDiagramInput.value = '';
                        if (exposureTypeInput) exposureTypeInput.value = '';
                    } else {
                        if (bodyDiagramContainer) bodyDiagramContainer.style.display = '';
                    }
                    validateForm();
                });
            });

            // Initialize current exposure type if one is selected
            const checkedRadio = document.querySelector('input[name="exposure_type"]:checked');
            if (checkedRadio) {
                currentExposureType = checkedRadio.value;
                exposureTypeInput.value = currentExposureType;
            }

            // If no radio was checked (but server provided an exposure via hidden input), use that
            if (!checkedRadio && exposureTypeInput && exposureTypeInput.value) {
                currentExposureType = exposureTypeInput.value;
                // reflect on the radio input if present
                try {
                    const radio = document.querySelector('input[name="exposure_type"][value="' + currentExposureType + '"]');
                    if (radio) radio.checked = true;
                } catch (e) {}
            }

            // Initialize animal ETC input display and value based on any pre-checked animal radio
            const checkedAnimal = document.querySelector('input[name="animal_type"]:checked');
            if (checkedAnimal) {
                if (checkedAnimal.value === 'etc') {
                    if (etcInput) etcInput.style.display = 'block';
                    if (etcTextInput) {
                        etcTextInput.required = true;
                        // If server provided an ETC text, prefill it
                        try { etcTextInput.value = "{{ session.appointment_details.animal_etc_text if session.appointment_details and session.appointment_details.animal_etc_text else '' }}"; } catch(e) {}
                    }
                } else {
                    if (etcInput) etcInput.style.display = 'none';
                    if (etcTextInput) {
                        etcTextInput.required = false;
                    }
                }
            }

                    bodyParts.forEach(part => {
                part.addEventListener('click', function() {
                    const partName = this.getAttribute('data-part');

                    if (selectedParts.includes(partName)) {
                        // Deselect the part
                        selectedParts = selectedParts.filter(p => p !== partName);
                        this.classList.remove('selected');
                    } else {
                        // Enforce maximum of 7 selections for all appointment types
                        if (selectedParts.length >= 7) {
                            // Show visual feedback that maximum is reached
                            showMaxSelectionsAlert();
                            return;
                        }

                        // Only allow selection if exposure type is selected
                        if (currentExposureType) {
                            // Select the part
                            selectedParts.push(partName);
                            this.classList.add('selected');
                        } else {
                            alert('Please select whether this was a bite or scratch first.');
                            return;
                        }
                    }
                    
                    // Update the hidden input
                    if (bodyDiagramInput) {
                        bodyDiagramInput.value = selectedParts.join(',');
                    }

                    // Update the display
                    updateSelectedParts();
                    // Re-validate form so Next button can enable when body parts change
                    validateForm();

                    // Auto-check ERIG vaccine when 'head' part is selected; uncheck when removed
                    try {
                        const hasHead = selectedParts.some(p => p.toLowerCase().includes('head'));
                        // Find ERIG radio if present
                        const erigRadio = Array.from(document.querySelectorAll('input[name="service"]')).find(i => i.value && i.value.toLowerCase().includes('erig'));
                        if (erigRadio) {
                            const lab = erigRadio.closest('label');
                            if (hasHead) {
                                try { erigRadio.checked = true; } catch(e) {}
                                if (lab) lab.classList.add('mandatory', 'service-card');
                            } else {
                                // Only remove mandatory mark and uncheck if it wasn't part of server-applied services
                                if (!normalizedServerServices.includes('erig') && !normalizedServerServices.includes('erig vaccine')) {
                                    try { erigRadio.checked = false; } catch(e) {}
                                    if (lab) lab.classList.remove('mandatory', 'service-card');
                                }
                            }
                        }
                    } catch (e) { console.log('DEBUG: error toggling ERIG based on head selection', e); }
                });
            });

            function updateSelectedParts() {
                if (selectedPartsContainer) {
                    selectedPartsContainer.innerHTML = '';

                    if (selectedParts.length === 0) {
                        selectedPartsContainer.innerHTML = `
                            <div class="text-center py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; margin: 1rem 0;">
                                <div style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h6 style="color: #6c757d; font-weight: 500; margin-bottom: 0.5rem;">No Areas Selected</h6>
                                <p style="color: #adb5bd; font-size: 0.9rem; margin: 0;">Click on the body diagram to select where you were bitten or scratched</p>
                                <div style="margin-top: 1rem;">
                                    <span style="background: #b20000; color: white; padding: 0.3em 0.8em; border-radius: 15px; font-size: 0.8rem;">Start by clicking body parts</span>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    // Summary header
                    const title = document.createElement('div');
                    title.className = 'mb-4';
                    title.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" style="color: #b20000; font-weight: 600; font-size: 1.1rem;">
                                Selected Areas (${currentExposureType ? currentExposureType.toUpperCase() : 'No Type Selected'})
                            </h5>
                            <span class="badge badge-primary" style="background: ${selectedParts.length >= 7 ? '#dc3545' : '#28a745'}; color: white; font-size: 0.8rem; padding: 0.4em 0.8em; border-radius: 12px;">
                                ${selectedParts.length}/7
                            </span>
                        </div>
                        <div style="height: 2px; background: linear-gradient(90deg, #b20000, #f8d7da); margin-bottom: 1rem;"></div>
                        ${selectedParts.length >= 7 ? '<div style="background: #f8d7da; color: #721c24; padding: 0.5rem; border-radius: 5px; margin-bottom: 1rem; font-size: 0.9rem;"><i class="fas fa-exclamation-triangle mr-2"></i>Maximum of 7 selections reached</div>' : ''}
                    `;
                    selectedPartsContainer.appendChild(title);

                    // Selected parts list
                    selectedParts.forEach((part, index) => {
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'mb-3';
                        itemContainer.style.cssText = `
                            background: white;
                            border: 1px solid #e9ecef;
                            border-radius: 10px;
                            padding: 1rem;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                            transition: all 0.2s ease;
                            position: relative;
                        `;

                        const badge = document.createElement('div');
                        badge.style.cssText = `
                            display: inline-flex;
                            align-items: center;
                            background: linear-gradient(135deg, #c41e3a, #b20000);
                            color: white;
                            padding: 0.6em 1.2em;
                            border-radius: 25px;
                            font-weight: 500;
                            font-size: 0.9rem;
                            box-shadow: 0 2px 6px rgba(196, 30, 58, 0.3);
                            margin-bottom: 0.5rem;
                        `;

                        const icon = document.createElement('i');
                        icon.className = `fas fa-${currentExposureType === 'bite' ? 'tooth' : 'claw-marks'} mr-2`;
                        icon.style.cssText = 'font-size: 0.8rem; opacity: 0.8; color: rgba(255,255,255,0.7);';

                        const text = document.createElement('span');
                        text.textContent = `${formatBodyPartName(part)} (${currentExposureType})`;

                        badge.appendChild(icon);
                        badge.appendChild(text);

                        const details = document.createElement('div');
                        details.style.cssText = `
                            font-size: 0.8rem;
                            color: #6c757d;
                            margin-top: 0.3rem;
                        `;

                        const detailIcon = document.createElement('i');
                        detailIcon.className = 'fas fa-info-circle mr-1';
                        detailIcon.style.cssText = 'font-size: 0.7rem; color: #b20000;';

                        const detailText = document.createElement('span');
                        detailText.textContent = `Body part #${index + 1} - ${currentExposureType}`;

                        details.appendChild(detailIcon);
                        details.appendChild(detailText);

                        itemContainer.appendChild(badge);
                        itemContainer.appendChild(details);
                        selectedPartsContainer.appendChild(itemContainer);
                    });
                }
            }

            function formatBodyPartName(partName) {
                return partName.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            // Clear all selections
            const clearButton = document.getElementById('clear-body-parts');
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    selectedParts = [];
                    bodyParts.forEach(part => part.classList.remove('selected'));
                    if (bodyDiagramInput) {
                        bodyDiagramInput.value = '';
                    }
                    updateSelectedParts();
                    validateForm();
                });
            }

            // Track animal type selection for ETC validation
            if (animalRadios.length > 0) {
                animalRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'etc' && this.checked) {
                            if (etcInput) etcInput.style.display = 'block';
                            if (etcTextInput) etcTextInput.required = true;
                        } else {
                            if (etcInput) etcInput.style.display = 'none';
                            if (etcTextInput) {
                                etcTextInput.required = false;
                                etcTextInput.value = '';
                            }
                        }
                        validateForm();
                    });
                });
            }

            // Track service selection
            if (serviceRadios.length > 0) {
                // If the appointment type is consultation, clear any pre-checked service radios to avoid
                // accidental browser autofill or previous selections causing the flow to skip.
                try {
                    const appointmentTypeVal = document.getElementById('appointment_type_input') ? document.getElementById('appointment_type_input').value : '';
                    if (appointmentTypeVal === 'consultation') {
                        serviceRadios.forEach(r => r.checked = false);
                        console.log('DEBUG: Cleared pre-checked service radios because appointment_type=consultation');
                    }
                } catch (e) {
                    console.log('DEBUG: Error while clearing service radios', e);
                }
                serviceRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        validateForm();
                    });
                });
            }

            // Track ETC text input
            if (etcTextInput) {
                etcTextInput.addEventListener('input', function() {
                    validateForm();
                });
            }

            // Initial validation
            validateForm();
        });

        // Function to show alert when maximum selections reached
        function showMaxSelectionsAlert() {
            // Create a temporary alert overlay
            const alertDiv = document.createElement('div');
            alertDiv.id = 'maxSelectionsAlert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-weight: 500;
                font-size: 14px;
                max-width: 300px;
                border-left: 4px solid #c82333;
                animation: slideInRight 0.3s ease-out;
            `;

            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 10px; font-size: 16px;"></i>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 2px;">Maximum Selections Reached</div>
                        <div style="font-size: 12px; opacity: 0.9;">You can select up to 7 body parts only</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: none;
                        border: none;
                        color: white;
                        margin-left: 15px;
                        cursor: pointer;
                        font-size: 18px;
                        padding: 0;
                        line-height: 1;
                    ">&times;</button>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 4000);
        }
    </script>

</body>
</html>
